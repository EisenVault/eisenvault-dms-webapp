define("tinymce/FocusManager",["tinymce/dom/DOMUtils","tinymce/Env"],function(f,b){var c,d,e=f.DOM;function a(n){function i(){try{return document.activeElement}catch(o){return document.body}}function m(o){if(o&&o.startContainer){return{startContainer:o.startContainer,startOffset:o.startOffset,endContainer:o.endContainer,endOffset:o.endOffset}}return o}function g(q,p){var o;if(p.startContainer){o=q.getDoc().createRange();o.setStart(p.startContainer,p.startOffset);o.setEnd(p.endContainer,p.endOffset)}else{o=p}return o}function l(o){return !!e.getParent(o,a.isEditorUIElement)}function h(q,p){var o=p.getBody();while(q){if(q==o){return true}q=q.parentNode}}function j(p){var o=p.editor;o.on("init",function(){if(o.inline||b.ie){o.on("nodechange keyup",function(){var q=document.activeElement;if(q&&q.id==o.id+"_ifr"){q=o.getBody()}if(h(q,o)){o.lastRng=o.selection.getRng()}});if(b.webkit&&!c){c=function(){var r=n.activeEditor;if(r&&r.selection){var q=r.selection.getRng();if(q&&!q.collapsed){o.lastRng=q}}};e.bind(document,"selectionchange",c)}}});o.on("setcontent",function(){o.lastRng=null});o.on("mousedown",function(){o.selection.lastFocusBookmark=null});o.on("focusin",function(){var q=n.focusedEditor;if(o.selection.lastFocusBookmark){o.selection.setRng(g(o,o.selection.lastFocusBookmark));o.selection.lastFocusBookmark=null}if(q!=o){if(q){q.fire("blur",{focusedEditor:o})}n.activeEditor=o;n.focusedEditor=o;o.fire("focus",{blurredEditor:q});o.focus(true)}o.lastRng=null;if(b.ie){o.selection.collapse(false)}});o.on("focusout",function(){window.setTimeout(function(){var q=n.focusedEditor;if(!l(i())&&q==o){o.fire("blur",{focusedEditor:null});n.focusedEditor=null;if(o.selection){o.selection.lastFocusBookmark=null}}},0)});if(!d){d=function(r){var q=n.activeEditor;if(q&&r.target.ownerDocument==document){if(q.selection){q.selection.lastFocusBookmark=m(q.lastRng)}if(!l(r.target)&&n.focusedEditor==q){q.fire("blur",{focusedEditor:null});n.focusedEditor=null}}};e.bind(document,"focusin",d)}}function k(o){if(n.focusedEditor==o.editor){n.focusedEditor=null}if(!n.activeEditor){e.unbind(document,"selectionchange",c);e.unbind(document,"focusin",d);c=d=null}}n.on("AddEditor",j);n.on("RemoveEditor",k)}a.isEditorUIElement=function(g){return g.className.toString().indexOf("mce-")!==-1};return a});